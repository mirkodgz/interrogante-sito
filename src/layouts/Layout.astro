---
import { ClientRouter } from "astro:transitions";
import "@fontsource/bebas-neue/400.css";
import "../styles/global.css";
import Header from "../components/blocks/Header";
import Footer from "../components/blocks/Footer";
import BackToTop from "../components/ui/BackToTop";
import { getCollection } from "astro:content";
import { navigationLinks } from "../data/navigation";
import { getLangFromUrl, useTranslations } from "../i18n/utils";

const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);

interface Props {
	title: string;
	description?: string;
	ogImage?: string;
}

const {
	title,
	description = "Gestión y promoción de espectáculos de alto nivel. Festival A PIEDI NUDI, teatro, talleres culturales y formación para profesores en Milán.",
	ogImage = "/og-image.jpg",
} = Astro.props;

// Fetch dynamic children filtered by language
const creaciones = await getCollection(
	"creaciones",
	({ data }) => data.language === lang,
);
console.log("CREACIONES DEBUG:", lang);
creaciones.forEach((c) => console.log(`- ${c.slug}: ${c.data.language}`));

const festival = await getCollection(
	"festival",
	({ data }) => data.language === lang,
);
const performance = await getCollection(
	"performance",
	({ data }) => data.language === lang,
);
console.log("Current Lang:", lang);
console.log("Festival Items found:", festival.length);
festival.forEach((f) => console.log(`- ${f.slug} (${f.data.language})`));

// Update navigationLinks with real data
const dynamicLinks = navigationLinks
	.filter((link) => link.title !== "PERFORMANCE") // Remove top-level PERFORMANCE
	.map((link) => {
		if (link.title === "CREACIONES") {
			const creacionesItems = creaciones.map((c) => {
				const slug = c.slug.split("/").pop();
				return {
					title: c.data.title,
					href:
						lang === "es"
							? `/creaciones/${slug}/`
							: `/${lang}/creazioni/${slug}/`,
				};
			});

			// Find if there's a PERFORMANCE placeholder in static children
			const staticChildren = link.children || [];
			const performancePlaceholder = staticChildren.find(
				(child) => child.title === "PERFORMANCE",
			);

			const finalChildren: any[] = [...creacionesItems];

			if (performancePlaceholder) {
				finalChildren.push({
					...performancePlaceholder,
					children: performance.map((p) => {
						// Strip 'es/' or 'it/' if needed, but Astro slug is the directory + file
						// If we use [lang] subdirs, the slug is 'es/slug'
						const slug = p.slug.split("/").pop();
						return {
							title: p.data.title,
							href:
								lang === "es"
									? `/performance/${slug}/`
									: `/${lang}/performance/${slug}/`,
						};
					}),
				});
			}

			return {
				...link,
				title:
					t(`nav.${link.title.toLowerCase()}` as any) || link.title,
				children: finalChildren.map((child) => {
					let childHref = child.href;
					if (
						lang === "it" &&
						!child.href.startsWith("http") &&
						!child.href.startsWith("#") &&
						!child.href.startsWith("/it")
					) {
						const childRouteMap: Record<string, string> = {
							"/formacion-para-profesores-de-espanol/":
								"/formazione-insegnanti/",
							"/talleres-para-ninos/": "/laboratori-per-bambini/",
							"/crea-tu-taller/": "/crea-il-tuo-laboratorio/",
							"/nosotros/team/kalua-rodriguez":
								"/chi-siamo/team/kalua-rodriguez",
							"/nosotros/team/yosvanis-gil":
								"/chi-siamo/team/yosvanis-gil",
							"/nosotros/team/yudel-collazo":
								"/chi-siamo/team/yudel-collazo",
							"/iniciativa-culturales-para-ninos/":
								"/iniziative-culturali-per-bambini/",
							"/jugando-en-espanol/": "/giocando-in-spagnolo/",
							"/abuela-te-hablo/": "/abuela-te-hablo/",
						};
						const mappedChildPath =
							childRouteMap[child.href] || child.href;
						childHref = `/it${mappedChildPath}`;
					}
					return { ...child, href: childHref };
				}),
			};
		}
		if (link.title === "FESTIVAL") {
			return {
				...link,
				title: t("nav.festival"),
				children: festival.map((f) => {
					const slug = f.slug.split("/").pop();
					return {
						title: f.data.title,
						href:
							lang === "es"
								? `/festival/${slug}/`
								: `/${lang}/festival/${slug}/`,
					};
				}),
			};
		}

		// Translate static link titles
		const translationKey = `nav.${link.title.toLowerCase()}` as any;
		const translatedTitle = t(translationKey);

		let finalHref = link.href;
		if (
			lang === "it" &&
			!link.href.startsWith("http") &&
			!link.href.startsWith("#")
		) {
			// Mapping for translated slugs
			const routeMap: Record<string, string> = {
				"/nosotros/": "/chi-siamo/",
				"/contacto/": "/contatto/",
				"/creaciones/": "/creazioni/",
				"/partners/": "/partners/",
				"/la-carretilla/": "/associati/",
				"/festival/": "/festival/",
				"/formacion-para-profesores-de-espanol/":
					"/formazione-insegnanti/",
				"/talleres-para-ninos/": "/laboratori-per-bambini/",
				"/crea-tu-taller/": "/crea-il-tuo-laboratorio/",
				"/iniciativa-culturales-para-ninos/":
					"/iniziative-culturali-per-bambini/",
				"/jugando-en-espanol/": "/giocando-in-spagnolo/",
				"/abuela-te-hablo/": "/abuela-te-hablo/",
			};

			const mappedPath = routeMap[link.href] || link.href;
			finalHref = `/it${mappedPath}`;
		}

		return {
			...link,
			title:
				translatedTitle !== translationKey
					? translatedTitle
					: link.title,
			href: finalHref,
			children: link.children?.map((child) => {
				let childHref = child.href;
				if (
					lang === "it" &&
					!child.href.startsWith("http") &&
					!child.href.startsWith("#")
				) {
					const childRouteMap: Record<string, string> = {
						"/formacion-para-profesores-de-espanol/":
							"/formazione-insegnanti/",
						"/talleres-para-ninos/": "/laboratori-per-bambini/",
						"/crea-tu-taller/": "/crea-il-tuo-laboratorio/",
						"/nosotros/team/kalua-rodriguez":
							"/chi-siamo/team/kalua-rodriguez",
						"/nosotros/team/yosvanis-gil":
							"/chi-siamo/team/yosvanis-gil",
						"/nosotros/team/yudel-collazo":
							"/chi-siamo/team/yudel-collazo",
						"/iniciativa-culturales-para-ninos/":
							"/iniziative-culturali-per-bambini/",
						"/jugando-en-espanol/": "/giocando-in-spagnolo/",
						"/abuela-te-hablo/": "/abuela-te-hablo/",
					};
					const mappedChildPath =
						childRouteMap[child.href] || child.href;
					childHref = `/it${mappedChildPath}`;
				}
				return { ...child, href: childHref };
			}),
		};
	});

const canonicalURL = new URL(Astro.url.pathname, Astro.site);
const socialImageURL = ogImage.startsWith("http")
	? ogImage
	: new URL(ogImage, Astro.site);

// Hreflang Logic
const currentPath = Astro.url.pathname;
let alternatePath = null;
let alternateLang = lang === "es" ? "it" : "es";

// Skip hreflang for blog as it's Spanish only
if (!currentPath.includes("/blog")) {
	if (lang === "es") {
		if (currentPath === "/" || currentPath === "") alternatePath = "/it/";
		else if (currentPath.startsWith("/nosotros"))
			alternatePath = currentPath.replace("/nosotros", "/it/chi-siamo");
		else if (currentPath.startsWith("/contacto"))
			alternatePath = currentPath.replace("/contacto", "/it/contatto");
		else if (currentPath.startsWith("/creaciones"))
			alternatePath = currentPath.replace("/creaciones", "/it/creazioni");
		// Festival and Performance keep the same base slug in Spanish, but need /it/ prefix + translated base if applicable
		// Based on file structure: src/pages/it/festival/[slug].astro -> /it/festival/[slug]
		// src/pages/it/performance/[slug].astro -> /it/performance/[slug]
		// So simple prefixing works for these if the slug bases are standard.
		// Wait, did I translate the 'performance' and 'festival' segments?
		// User requirement: "Italiano (it) accessible via the /it/ prefix."
		// In Layout navigation we used: /it/festival/[slug].
		// So festival and performance seem to keep the word in Italian (same).
		else if (currentPath.startsWith("/iniciativa-culturales-para-ninos"))
			alternatePath = currentPath.replace(
				"/iniciativa-culturales-para-ninos",
				"/it/iniziative-culturali-per-bambini",
			);
		else if (currentPath.startsWith("/jugando-en-espanol"))
			alternatePath = currentPath.replace(
				"/jugando-en-espanol",
				"/it/giocando-in-spagnolo",
			);
		else if (currentPath.startsWith("/abuela-te-hablo"))
			alternatePath = currentPath.replace(
				"/abuela-te-hablo",
				"/it/abuela-te-hablo",
			);
		else alternatePath = `/it${currentPath}`;
	} else {
		if (currentPath === "/it/" || currentPath === "/it")
			alternatePath = "/";
		else if (currentPath.startsWith("/it/chi-siamo"))
			alternatePath = currentPath.replace("/it/chi-siamo", "/nosotros");
		else if (currentPath.startsWith("/it/contatto"))
			alternatePath = currentPath.replace("/it/contatto", "/contacto");
		else if (currentPath.startsWith("/it/creazioni"))
			alternatePath = currentPath.replace("/it/creazioni", "/creaciones");
		else if (currentPath.startsWith("/it/iniziative-culturali-per-bambini"))
			alternatePath = currentPath.replace(
				"/it/iniziative-culturali-per-bambini",
				"/iniciativa-culturales-para-ninos",
			);
		else if (currentPath.startsWith("/it/giocando-in-spagnolo"))
			alternatePath = currentPath.replace(
				"/it/giocando-in-spagnolo",
				"/jugando-en-espanol",
			);
		else alternatePath = currentPath.replace("/it", "") || "/";
	}
}

const alternateURL = alternatePath ? new URL(alternatePath, Astro.site) : null;
---

<!doctype html>
<html lang={lang}>
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width" />
		<link rel="icon" type="image/png" href="/favicon-interrogante.png" />
		<meta name="generator" content={Astro.generator} />

		<!-- Primary Meta Tags -->
		<title>
			{
				title.startsWith("Interrogante Spettacolo")
					? title
					: `${title} | Interrogante Spettacolo - Compañía Artística`
			}
		</title>
		<meta
			name="title"
			content={title.startsWith("Interrogante Spettacolo")
				? title
				: `${title} | Interrogante Spettacolo - Compañía Artística`}
		/>
		<meta name="description" content={description} />
		<link rel="canonical" href={canonicalURL} />
		{
			alternateURL && (
				<link
					rel="alternate"
					hreflang={alternateLang}
					href={alternateURL}
				/>
			)
		}
		<link rel="alternate" hreflang={lang} href={canonicalURL} />

		<ClientRouter />

		<!-- Open Graph / Facebook -->
		<meta property="og:type" content="website" />
		<meta property="og:url" content={Astro.url} />
		<meta
			property="og:title"
			content={`${title} | Interrogante Spettacolo - Compañía Artística`}
		/>
		<meta property="og:description" content={description} />
		<meta property="og:image" content={socialImageURL} />
		<meta property="og:site_name" content="Interrogante Spettacolo" />

		<!-- Twitter -->
		<meta property="twitter:card" content="summary_large_image" />
		<meta property="twitter:url" content={Astro.url} />
		<meta
			property="twitter:title"
			content={`${title} | Interrogante Spettacolo - Compañía Artística`}
		/>
		<meta property="twitter:description" content={description} />
		<meta property="twitter:image" content={socialImageURL} />

		<meta
			name="keywords"
			content="Interrogante Spettacolo, teatro milan, festival a piedi nudi, cultura española milan, talleres teatro, formación profesores español, teatro multicultural, booking artistas milan"
		/>
		<script type="application/ld+json" is:inline>
			{
				"@context": "https://schema.org",
				"@type": "PerformingGroup",
				"name": "Interrogante Spettacolo",
				"url": "https://interrogantespettacolo.com",
				"logo": "https://interrogantespettacolo.com/Logo-Interrogante-white2.svg",
				"description": "Compañía Artística referente en cultura española y latinoamericana en Milán. Organizadores del Festival A PIEDI NUDI.",
				"sameAs": [
					"https://www.instagram.com/interrogantespettacolo",
					"https://www.facebook.com/interrogantespettacolo"
				],
				"address": {
					"@type": "PostalAddress",
					"addressLocality": "Milano",
					"addressCountry": "IT"
				}
			}
		</script>
	</head>
	<body class="min-h-screen flex flex-col">
		<Header client:load links={dynamicLinks} lang={lang} />
		<div class="grow">
			<slot />
		</div>
		<Footer client:load lang={lang} />
		<BackToTop client:load />
	</body>
</html>
